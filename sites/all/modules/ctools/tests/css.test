<?php
/**
 * @file
 * Tests for different parts of the ctools plugin system.
 */

/**
 * Test menu links depending on user permissions.
 */
class CtoolsCssTestCase extends DrupalWebTestCase {
<<<<<<< HEAD

  /**
   * {@inheritdoc}
   */
=======
>>>>>>> 9d9f2490f... Upload modules,themes and libraries
  public static function getInfo() {
    return array(
      'name' => 'CSS Tools tests',
      'description' => '...',
      'group' => 'ctools',
    );
  }

<<<<<<< HEAD
  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = array()) {
    $modules[] = 'ctools';
    parent::setUp($modules);
    ctools_include('css');
=======
  function setUp() {
    // Additionally enable contact module.
    parent::setUp('ctools');
>>>>>>> 9d9f2490f... Upload modules,themes and libraries
  }

  /**
   * Test that cached plugins are loaded correctly.
   */
  function testCssStuff() {
    $css = "#some-id .some-class {\n  color: black;\n  illegal-key: foo;\n}";
    $filtered_css = '#some-id .some-class{color:black;}';

    ctools_include('css');
    $filename1 = ctools_css_store('unfiltered-css-test', $css, FALSE);
    $filename2 = ctools_css_store('filtered-css-test', $css, TRUE);

    $this->assertEqual($filename1, ctools_css_retrieve('unfiltered-css-test'), 'Unfiltered css file successfully fetched');
    $file_contents = file_get_contents($filename1);
    $this->assertEqual($css, $file_contents, 'Unfiltered css file contents are correct');
//    $match = $filename1 == ctools_css_retrieve('unfiltered-css-test') ? 'Match' : 'No match';
//    $output .= '<pre>Unfiltered: ' . $filename1 . ' ' . $match . '</pre>';
//    $output .= '<pre>' . file_get_contents($filename1) . '</pre>';

    $this->assertEqual($filename2, ctools_css_retrieve('filtered-css-test'), 'Filtered css file succcesfully fetched');
    $file_contents = file_get_contents($filename2);
    $this->assertEqual($filtered_css, $file_contents, 'Filtered css file contents are correct');
<<<<<<< HEAD
  }

  /**
   * Test that Stored CSS snippets can be correctly overwritten.
   */
  public function testCssStoreOverwrite() {
    $css1 = "#some-id .some-class {\n  color: black;\n  illegal-key: foo;\n}";

    $css2 = "#other-id .other-class {\n  color: blue;\n  illegal-key: foo;\n}";
    $filtered_css2 = '#other-id .other-class{color:blue;}';

    ctools_css_store('unfiltered-css-test', $css1, FALSE);
    ctools_css_store('filtered-css-test', $css1, TRUE);

    // Now overwrite the first css with the second version.
    $filename3 = ctools_css_store('unfiltered-css-test', $css2, FALSE);
    $filename4 = ctools_css_store('filtered-css-test', $css2, TRUE);

    $file_contents3 = file_get_contents($filename3);
    $file_contents4 = file_get_contents($filename4);

    $this->assertEqual($css2, $file_contents3, 'Unfiltered CSS has overwritten earlier contents.');
    $this->assertEqual($filtered_css2, $file_contents4, 'Filtered CSS has overwritten earlier contents.');
  }
=======
    //    $match = $filename2 == ctools_css_retrieve('filtered-css-test') ? 'Match' : 'No match';
//    $output .= '<pre>Filtered: ' . $filename2 . ' ' . $match . '</pre>';
//    $output .= '<pre>' . file_get_contents($filename2) . '</pre>';
//
//    drupal_add_css($filename2, array('type' => 'file'));
//    return array('#markup' => $output);

>>>>>>> 9d9f2490f... Upload modules,themes and libraries

    // Test that in case that url can be used, the value surives when a colon is in it.
    $css = "#some-id {\n  background-image: url(http://example.com/example.gif);\n}";
    $css_data = ctools_css_disassemble($css);
    $empty_array = array();
    $disallowed_values_regex = '/(expression)/';
    $filtered = ctools_css_assemble(ctools_css_filter_css_data($css_data, $empty_array, $empty_array, '', $disallowed_values_regex));
    $url = (strpos($filtered, 'http://example.com/example.gif') !== FALSE);
    $this->assertTrue($url, 'CSS with multiple colons can survive.');

    // Test that in case the CSS has two properties defined are merged.
    $css = "#some-id {\n  font-size: 12px;\n}\n#some-id {\n  color: blue;\n}";
    $filtered = ctools_css_filter($css);
    $font_size = (strpos($filtered, 'font-size:12px;') !== FALSE);
    $color = (strpos($filtered, 'color:blue') !== FALSE);
    $this->assertTrue($font_size && $color, 'Multiple properties are merged.');

    $css = '@import url("other.css");p {color: red;}';
    $filtered = ctools_css_filter($css);
    $other_css = (strpos($filtered, 'other.css') === FALSE);
    $color = (strpos($filtered, 'color:red') !== FALSE);
    $this->assertTrue($other_css && $color, 'CSS is properly sanitized.');

    $css = ';p {color: red; font-size: 12px;}';
    $filtered = ctools_css_filter($css);
    $font_size = (strpos($filtered, 'font-size:12px;') !== FALSE);
    $color = (strpos($filtered, 'color:red') !== FALSE);
    $this->assertTrue($font_size && $color, 'Multiple properties are retained.');
  }
}
